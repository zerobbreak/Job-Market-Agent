# =============================================================================
# Job Market AI Analyzer - Docker Compose with Multiple Build Modes
# =============================================================================
# Supports different build configurations for development and production

services:
  # Production build with full ML libraries (optimized caching)
  production:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: job-market-analyzer-prod
    environment:
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - CV_FILE_PATH=/app/CV.pdf
      - PRODUCTION=true
    volumes:
      - ./CV.pdf:/app/CV.pdf:ro
      - ./job_cache:/app/job_cache:rw
      - ./.env:/app/.env:ro
    networks:
      - job-market-network
    restart: unless-stopped
    profiles: ["production"]

  # Development build with slim dependencies (fast builds)
  development:
    build:
      context: .
      dockerfile: Dockerfile.dev
      target: development
    container_name: job-market-analyzer-dev
    environment:
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - CV_FILE_PATH=/app/CV.pdf
      - DEV_MODE=true
    volumes:
      - ./CV.pdf:/app/CV.pdf:ro
      - ./job_cache:/app/job_cache:rw
      - ./.env:/app/.env:ro
      # Mount source code for development
      - .:/app:ro
      - /app/__pycache__
    networks:
      - job-market-network
    restart: unless-stopped
    profiles: ["development"]

  # Multi-stage production build (smaller final image)
  multi-stage:
    build:
      context: .
      dockerfile: Dockerfile.multi
      target: runtime
    container_name: job-market-analyzer-multi
    environment:
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - CV_FILE_PATH=/app/CV.pdf
      - PRODUCTION=true
      - MULTI_STAGE=true
    volumes:
      - ./CV.pdf:/app/CV.pdf:ro
      - ./job_cache:/app/job_cache:rw
      - ./.env:/app/.env:ro
    networks:
      - job-market-network
    restart: unless-stopped
    profiles: ["multi-stage"]

  # Default service (uses optimized production build)
  job-market-analyzer:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: job-market-analyzer
    environment:
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - CV_FILE_PATH=/app/CV.pdf
      - PRODUCTION=true
    volumes:
      - ./CV.pdf:/app/CV.pdf:ro
      - ./job_cache:/app/job_cache:rw
      - ./.env:/app/.env:ro
    networks:
      - job-market-network
    restart: unless-stopped

networks:
  job-market-network:
    driver: bridge
